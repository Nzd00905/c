<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Garden</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Load Monetag SDK -->
    <!-- Make sure to replace 10157784 with your actual zone ID -->
    <script src='//libtl.com/sdk.js' data-zone='10157784' data-sdk='show_10157784'></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Dark background from screenshots */
            color: #e0e0e0;
        }
        /* Gradient header */
        .header-gradient {
            background: linear-gradient(90deg, #d8349c, #8E2DE2); /* Pinkish gradient from screenshots */
        }
        /* Gradient button */
        .btn-gradient {
            background: linear-gradient(90deg, #c94dff, #ac2dff);
        }
        .btn-gradient:hover {
            background: linear-gradient(90deg, #ac2dff, #c94dff);
        }
        /* Card background */
        .card-bg {
            background-color: #2a2a4e; /* Darker card background */
        }
        .nav-bg {
            background-color: #242442;
        }
        /* Active nav item */
        .nav-item.active {
            color: #c94dff;
        }
        /* Hide all pages by default */
        .page {
            display: none;
        }
        /* Show the active page */
        .page.active {
            display: block;
        }
    </style>
</head>
<body class="h-full overflow-hidden">

    <!-- Main Application Container -->
    <div class="flex flex-col h-full max-w-md mx-auto shadow-lg">

        <!-- Header -->
        <header id="main-header" class="header-gradient p-4 rounded-b-2xl shadow-lg flex items-center justify-between z-10">
            <div class="flex items-center space-x-3">
                <!-- Updated with ID and error fallback -->
                <img id="profile-photo" src="https://placehold.co/40x40/ffffff/8E2DE2?text=MD" alt="Profile" class="w-10 h-10 rounded-full border-2 border-white" onerror="this.src='https://placehold.co/40x40/ffffff/8E2DE2?text=MD';">
                <div>
                    <!-- Updated with ID -->
                    <h1 id="profile-name" class="text-lg font-bold text-white">Md.Sabbir</h1>
                    <div class="bg-white/30 backdrop-blur-sm text-white px-3 py-0.5 rounded-full text-sm inline-flex items-center space-x-1">
                        <span>üí∞</span>
                        <span>‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏:</span>
                        <span class="font-bold" id="balance-display-header">0.00</span> 
                        <span>TAKA</span>
                    </div>
                </div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </header>
        
        <!-- Page-specific Header for History -->
        <header id="history-header" class="header-gradient p-4 rounded-b-2xl shadow-lg z-10 hidden">
             <h1 class="text-xl font-bold text-white text-center pt-4">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶≤ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h1>
        </header>

        <!-- Main Content Area (Scrollable) -->
        <main class="flex-1 overflow-y-auto p-4 pb-20">

            <!-- Page: Home -->
            <section id="page-home" class="page active space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="card-bg p-4 rounded-xl text-center shadow-lg relative">
                        <span class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">Ad</span>
                        <div class="text-xs text-gray-400 mb-1">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ</div>
                        <div class="text-2xl font-bold" id="task-progress-display">0/20</div>
                    </div>
                    <div class="card-bg p-4 rounded-xl text-center shadow-lg">
                        <div class="text-xs text-gray-400 mb-1">‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞</div>
                        <div class="text-2xl font-bold" id="referral-display">0</div>
                    </div>
                </div>

                <div class="card-bg p-4 rounded-xl shadow-lg space-y-3">
                    <h2 class="text-lg font-semibold text-center">üéÅ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶ï‡ßá ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                    <p class="text-sm text-gray-300 text-center">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ü‡¶ø ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶Ü‡¶Æ‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶ø 45 TAKA ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§</p>
                    <div class="bg-green-600/30 text-green-300 text-sm font-semibold text-center p-2 rounded-lg">
                        ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá 45 TAKA ‡¶¨‡ßã‡¶®‡¶æ‡¶∏
                    </div>
                    <div class="bg-gray-800 p-3 rounded-lg text-center text-sm break-all" id="referral-link">
                        Loading link...
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="copy-link-btn" class="btn-gradient text-white font-semibold py-3 rounded-lg flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                                <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" />
                            </svg>
                            <span>‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                        </button>
                        <button class="bg-gradient-to-r from-blue-400 to-teal-400 text-white font-semibold py-3 rounded-lg flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                            </svg>
                            <span>‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                        </button>
                    </div>
                    <!-- Button to simulate getting a referral for testing -->
                    <button id="simulate-referral-btn" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg text-sm mt-2">
                        ‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ (‡¶ü‡ßá‡¶∏‡ßç‡¶ü)
                    </button>
                </div>
            </section>

            <!-- Page: Support -->
            <section id="page-support" class="page space-y-4">
                <div class="card-bg p-4 rounded-xl shadow-lg text-center">
                    <div class="w-16 h-16 btn-gradient rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold mb-2">‡¶ü‡¶ø‡¶â‡¶ü‡ßã‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì</h2>
                    <p class="text-sm text-gray-300 mb-4">‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®-‡¶ü‡¶ø‡¶â‡¶ü‡ßã‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡ßá ‡¶®‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶π‡¶ú‡ßá‡¶á ‡¶Ü‡ßü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <button class="w-full btn-gradient text-white font-bold py-3 rounded-lg">
                        ‡¶ü‡¶ø‡¶â‡¶ü‡ßã‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                    </button>
                </div>
                <div class="card-bg p-4 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold mb-3">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø</h2>
                    <a href="#" class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                        <span class="text-blue-400">‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            </section>

            <!-- Page: Tasks -->
            <section id="page-tasks" class="page space-y-4">
                <div class="card-bg p-4 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡ßç‡¶∞‡ßã‡¶ó‡ßç‡¶∞‡ßá‡¶∏</h2>
                        <span class="font-bold text-lg" id="task-progress-display-2">0/20</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2.5">
                        <div id="task-progress-bar" class="btn-gradient h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="text-sm text-gray-300 text-center mt-2" id="task-remaining-text">
                        ‡¶Ü‡¶ú ‡ß®‡ß¶ ‡¶ü‡¶ø ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá
                    </div>
                </div>

                <div class="card-bg p-4 rounded-xl shadow-lg text-center space-y-3">
                    <div class="text-5xl">üìπ</div>
                    <h2 class="text-lg font-semibold">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</h2>
                    <p class="text-sm text-gray-300">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßá 30.00 TAKA ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <div class="text-xl font-bold text-green-400">üíµ ‡¶∞‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°: 30.00 TAKA</div>
                    <button id="watch-ad-btn" class="w-full btn-gradient text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        <span>‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</span>
                    </button>
                    <div id="task-complete-message" class="text-green-400 font-semibold p-3 bg-green-900/50 rounded-lg hidden">
                        ‚ìò ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®
                    </div>
                </div>
            </section>

            <!-- Page: Withdraw -->
            <section id="page-withdraw" class="page space-y-4">
                <div class="card-bg p-4 rounded-xl shadow-lg text-center">
                    <div class="text-sm text-gray-300">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
                    <div class="text-3xl font-bold my-1" id="balance-display-withdraw">0.00 <span class="text-lg">TAKA</span></div>
                </div>

                <div class="card-bg p-4 rounded-xl shadow-lg space-y-4">
                    <h2 class="text-lg font-semibold text-center mb-2">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®</h2>
                    
                    <div class="bg-gray-800 p-3 rounded-lg">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-300">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø</span>
                            <span class="font-semibold text-green-400">800.00 TAKA</span>
                        </div>
                        <div class="flex justify-between items-center text-sm mt-1">
                            <span class="text-gray-300">‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</span>
                            <span class="font-semibold text-green-400">18 ‡¶ú‡¶®</span>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-300">‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                        <select class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option>‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                            <option>Bkash</option>
                            <option>Nagad</option>
                            <option>Rocket</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-300">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
                        <input type="text" placeholder="01XXXXXXXXX" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-300">Amount (TAKA)</label>
                        <input type="number" id="withdraw-amount" placeholder="Minimum 800.00 TAKA" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <button id="withdraw-btn" class="w-full btn-gradient text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                        </svg>
                        <span>‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</span>
                    </button>
                </div>
            </section>

            <!-- Page: History -->
            <section id="page-history" class="page space-y-4">
                <div class="card-bg p-4 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold mb-3">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶≤ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</h2>
                    <div id="history-list">
                        <!-- History items will be injected here -->
                    </div>
                    <div id="no-history-message" class="text-center py-10">
                        <div class="text-5xl mb-4">üìÑ</div>
                        <p class="font-semibold">‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶≤ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü ‡¶®‡¶ø‡•§</p>
                        <p class="text-sm text-gray-400">‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶≤ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶®‡¶®‡¶ø‡•§</p>
                    </div>
                </div>
            </section>

        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="nav-bg fixed bottom-0 left-0 right-0 max-w-md mx-auto h-16 rounded-t-2xl flex justify-around items-center z-10 shadow-inner">
            <button class="nav-item active p-2" data-page="home">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                <span class="text-xs">‡¶π‡ßã‡¶Æ</span>
            </button>
            <button class="nav-item p-2" data-page="support">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                <span class="text-xs">‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</span>
            </button>
            <button class="nav-item p-2" data-page="tasks">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v10a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm3 2a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                <span class="text-xs">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</span>
            </button>
            <button class="nav-item p-2" data-page="withdraw">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                <span class="text-xs">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞</span>
            </button>
            <button class="nav-item p-2" data-page="history">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                <span class="text-xs">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</span>
            </button>
        </nav>
    </div>

    <!-- Loading Screen Overlay -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="card-bg p-6 rounded-2xl shadow-2xl w-10/12 max-w-sm text-center">
            <div class="w-16 h-16 btn-gradient rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Loading Your Dashboard</h2>
            <p class="text-sm text-gray-300 mb-4">Securely syncing your profile & configuration</p>
            <div class="w-full bg-gray-800 rounded-full h-2.5">
                <div id="loading-bar" class="btn-gradient h-2.5 rounded-full" style="width: 10%"></div>
            </div>
            <ul class="text-left text-sm text-gray-400 mt-4 space-y-1" id="loading-steps">
                <li id="step-1" class="opacity-50">1. Secure connection established</li>
                <li id="step-2" class="opacity-50">2. Verifying Telegram account...</li>
                <li id="step-3" class="opacity-50">3. Loading user profile...</li>
                <li id="step-4" class="opacity-50">4. Syncing configuration...</li>
            </ul>
        </div>
    </div>

    <!-- Notice Modal -->
    <div id="notice-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm z-40 flex items-center justify-center p-4 hidden">
        <div class="card-bg p-6 rounded-2xl shadow-2xl w-10/12 max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-4">üîî ‡¶®‡ßã‡¶ü‡¶ø‡¶∏</h2>
            <div class="text-left space-y-2 text-gray-200">
                <p>üî• ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ! ‡¶∏‡¶§‡¶§‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶õ‡¶ø‡•§ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶Æ‡ßá‡¶®‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶≤‡ßá ‡ßß‡ß¶‡ß¶% ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶¨‡ßá‡¶® ‡¶á‡¶®‡¶∂‡¶æ‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π‡•§</p>
                <p>‚ö° ‡¶ú‡ßü‡ßá‡¶® ‡¶¨‡ßã‡¶®‡¶æ‡¶∏: ‡ß®‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                <p>üßë‚Äçü§ù‚Äçüßë ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá: ‡ßß‡ß´ ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                <p>üí∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡ßá: ‡ß©‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                <p>‚ù§Ô∏è ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡ß®‡ß¶ ‡¶ü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó</p>
                <p>üëç ‡¶è‡¶á ‡¶∏‡¶æ‡¶á‡¶ü‡ßá ‡¶ï‡ßã‡¶® ‡¶á‡¶®‡¶≠‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶®‡¶æ</p>
            </div>
            <button id="close-notice-btn" class="w-full btn-gradient text-white font-bold py-3 rounded-lg mt-6">
                ‡¶¨‡ßÅ‡¶ù‡ßá‡¶õ‡¶ø
            </button>
        </div>
    </div>
    
    <!-- Custom Message Modal (for alerts) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="card-bg p-6 rounded-2xl shadow-2xl w-10/12 max-w-sm text-center">
            <div id="message-icon" class="text-5xl mb-4"></div>
            <h2 id="message-title" class="text-xl font-bold mb-2"></h2>
            <p id="message-text" class="text-sm text-gray-300 mb-4"></p>
            <button id="close-message-btn" class="w-full bg-gray-600 text-white font-bold py-2 rounded-lg">
                Close
            </button>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot,
            collection,
            addDoc,
            query
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Initialize Telegram Web App ---
        try {
            window.Telegram.WebApp.ready();
            console.log("Telegram Web App SDK initialized.");
        } catch (e) {
            console.log("Not in Telegram environment.");
        }

        // --- Configs ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-money-garden';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const TASK_REWARD = 30;
        const REFERRAL_BONUS = 45; // From home page screenshot
        const JOIN_BONUS = 20; // From notice screenshot
        const MAX_TASKS = 20;
        const MIN_WITHDRAW = 800;
        const MIN_REFERRALS = 18;
        
        // --- Firebase Init ---
        let app, auth, db, userId, userProfileRef, userProfileUnsubscribe;
        let withdrawalHistoryUnsubscribe;
        let localState = {
            balance: 0,
            referrals: 0,
            tasksCompleted: 0,
            telegramFirstName: null,
            telegramPhotoUrl: null
        };
        let adSdkReady = false; // Flag to track if ad SDK is loaded

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            showMessage("Error", "Could not connect to services.", "üö´");
        }

        // --- Loading Screen Logic ---
        const loadingBar = document.getElementById('loading-bar');
        const loadingSteps = {
            1: document.getElementById('step-1'),
            2: document.getElementById('step-2'),
            3: document.getElementById('step-3'),
            4: document.getElementById('step-4'),
        };
        
        function updateLoading(step, text) {
            if (loadingSteps[step]) {
                loadingSteps[step].textContent = text;
                loadingSteps[step].classList.remove('opacity-50');
                loadingSteps[step].classList.add('text-white');
            }
            loadingBar.style.width = `${step * 25}%`;
        }

        // --- Custom Message Modal ---
        const messageModal = document.getElementById('message-modal');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const messageIcon = document.getElementById('message-icon');
        const closeMessageBtn = document.getElementById('close-message-btn');

        function showMessage(title, text, icon = "‚úÖ") {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageIcon.textContent = icon;
            messageModal.classList.remove('hidden');
        }
        closeMessageBtn.onclick = () => messageModal.classList.add('hidden');


        // --- Auth State ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                updateLoading(2, "2. Verifying Telegram account...");
                userId = user.uid;
                userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                
                // Attach real-time listener for user profile
                attachProfileListener();
                // Attach real-time listener for withdrawal history
                attachHistoryListener();

                // Update referral link
                const refLinkEl = document.getElementById('referral-link');
                // Use the Telegram bot link structure
                refLinkEl.textContent = `https://t.me/moneygardenn_bot/app?startapp=${userId}`;
                
            } else {
                // Not authenticated, try to sign in
                console.log("No user. Signing in...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Sign-in failed:", e);
                    updateLoading(2, "2. Authentication failed.");
                    showMessage("Auth Error", "Could not authenticate user.", "üö´");
                }
            }
        });

        // --- Firestore Listeners ---
        
        // Listen for profile changes (balance, tasks, etc.)
        function attachProfileListener() {
            if (userProfileUnsubscribe) userProfileUnsubscribe(); // Detach old listener
            
            userProfileUnsubscribe = onSnapshot(userProfileRef, (docSnap) => {
                updateLoading(3, "3. Loading user profile...");
                let tgUser = null;
                try {
                    tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
                } catch(e) { console.log("Telegram data not available."); }

                
                if (docSnap.exists()) {
                    // Profile exists, update local state and UI
                    const data = docSnap.data();
                    localState = {
                        balance: data.balance || 0,
                        referrals: data.referrals || 0,
                        tasksCompleted: data.tasksCompleted || 0,
                        telegramFirstName: data.telegramFirstName, // Load from DB
                        telegramPhotoUrl: data.telegramPhotoUrl // Load from DB
                    };
                    
                    // --- Check for Telegram data and sync ---
                    let profileUpdates = {};
                    if (tgUser) {
                        const tgName = tgUser.first_name || tgUser.username || "User";
                        
                        // Update local state for immediate UI update
                        localState.telegramFirstName = tgName;
                        localState.telegramPhotoUrl = tgUser.photo_url;
                        
                        // Check if DB needs updating
                        if (data.telegramFirstName !== tgName) {
                            profileUpdates.telegramFirstName = tgName;
                        }
                        if (data.telegramPhotoUrl !== tgUser.photo_url) {
                            profileUpdates.telegramPhotoUrl = tgUser.photo_url;
                        }
                        if (data.telegramId !== tgUser.id) {
                            profileUpdates.telegramId = tgUser.id;
                        }

                        // If there are changes, update Firestore
                        if (Object.keys(profileUpdates).length > 0) {
                            updateDoc(userProfileRef, profileUpdates)
                                .then(() => console.log("Synced Telegram info to profile."))
                                .catch(e => console.error("Failed to sync Telegram info", e));
                        }
                    }
                    // --- End Telegram sync ---

                    console.log("Profile data updated:", localState);
                    updateUI(localState);
                    updateLoading(4, "4. Syncing configuration...");
                    
                    // Finish loading
                    setTimeout(() => {
                        document.getElementById('loading-screen').classList.add('hidden');
                        // Show notice modal only once
                        if (!localStorage.getItem('noticeShown')) {
                            document.getElementById('notice-modal').classList.remove('hidden');
                            localStorage.setItem('noticeShown', 'true');
                        }
                        
                        // --- Start checking for Ad SDK ---
                        checkAdSdkReady();

                    }, 500);

                } else {
                    // Profile doesn't exist, create it
                    console.log("No profile found. Creating one...");
                    const initialProfile = {
                        balance: JOIN_BONUS,
                        referrals: 0,
                        tasksCompleted: 0,
                        joinedAt: new Date()
                    };
                    
                    // --- Add Telegram data if available on creation ---
                    if (tgUser) {
                        initialProfile.telegramFirstName = tgUser.first_name || tgUser.username;
                        initialProfile.telegramPhotoUrl = tgUser.photo_url;
                        initialProfile.telegramId = tgUser.id;
                    }
                    // --- End Telegram data ---
                    
                    setDoc(userProfileRef, initialProfile)
                        .then(() => console.log("Profile created.", initialProfile))
                        .catch(e => console.error("Error creating profile:", e));
                    // The listener will fire again with the new data
                }
            }, (error) => {
                console.error("Error listening to profile:", error);
                showMessage("Database Error", "Could not load user profile.", "üö´");
            });
        }
        
        // Listen for withdrawal history changes
        function attachHistoryListener() {
            if (withdrawalHistoryUnsubscribe) withdrawalHistoryUnsubscribe();
            
            const historyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/withdrawals`);
            const q = query(historyCollectionRef); // We can add orderBy here if we store a timestamp
            
            withdrawalHistoryUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const historyList = document.getElementById('history-list');
                const noHistoryMessage = document.getElementById('no-history-message');
                historyList.innerHTML = ''; // Clear list
                
                if (querySnapshot.empty) {
                    noHistoryMessage.style.display = 'block';
                } else {
                    noHistoryMessage.style.display = 'none';
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();
                        const date = item.requestedAt?.toDate ? item.requestedAt.toDate().toLocaleDateString() : 'N/A';
                        const itemEl = document.createElement('div');
                        itemEl.className = 'bg-gray-800 p-3 rounded-lg mb-2 flex justify-between items-center';
                        itemEl.innerHTML = `
                            <div>
                                <div class="font-semibold">${item.method} - ${item.accountNumber}</div>
                                <div class="text-sm text-gray-400">${date}</div>
                            </div>
                            <div class="text-lg font-bold text-right">
                                ${item.amount} TAKA
                                <div class="text-sm font-normal ${item.status === 'Pending' ? 'text-yellow-400' : 'text-green-400'}">${item.status}</div>
                            </div>
                        `;
                        historyList.appendChild(itemEl);
                    });
                }
            }, (error) => {
                console.error("Error listening to history:", error);
            });
        }

        // --- Ad SDK Ready Check ---
        function checkAdSdkReady() {
            const watchAdBtn = document.getElementById('watch-ad-btn');
            if (!watchAdBtn) {
                // DOM not ready, try again
                setTimeout(checkAdSdkReady, 200);
                return;
            }
            
            const btnText = watchAdBtn.querySelector('span');

            if (typeof show_10157784 === 'function') {
                console.log("Monetag SDK is ready.");
                adSdkReady = true;
                // Re-run UI update to set button state correctly based on tasks
                updateUI(localState);
            } else {
                // Not ready, disable button and retry
                console.warn("Monetag SDK not ready, polling...");
                adSdkReady = false;
                // Update UI will handle disabling the button
                updateUI(localState);
                
                setTimeout(checkAdSdkReady, 1000); // Check again in 1 second
            }
        }

        // --- UI Update Function ---
        function updateUI(data) {
            // --- Header (Now dynamic) ---
            document.getElementById('profile-name').textContent = data.telegramFirstName || "Md.Sabbir";
            const profilePhoto = data.telegramPhotoUrl || "https://placehold.co/40x40/ffffff/8E2DE2?text=MD";
            document.getElementById('profile-photo').src = profilePhoto;
            
            document.getElementById('balance-display-header').textContent = data.balance.toFixed(2);
            
            // Home Page
            document.getElementById('task-progress-display').textContent = `${data.tasksCompleted}/${MAX_TASKS}`;
            document.getElementById('referral-display').textContent = data.referrals;
            
            // Task Page
            const tasksDone = data.tasksCompleted;
            const progressPercent = (tasksDone / MAX_TASKS) * 100;
            document.getElementById('task-progress-display-2').textContent = `${tasksDone}/${MAX_TASKS}`;
            document.getElementById('task-progress-bar').style.width = `${progressPercent}%`;
            document.getElementById('task-remaining-text').textContent = `‡¶Ü‡¶ú ${MAX_TASKS - tasksDone} ‡¶ü‡¶ø ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá`;
            
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const taskCompleteMsg = document.getElementById('task-complete-message');
            
            if (tasksDone >= MAX_TASKS) {
                watchAdBtn.disabled = true;
                watchAdBtn.classList.add('opacity-50', 'cursor-not-allowed');
                watchAdBtn.querySelector('span').textContent = '‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®';
                taskCompleteMsg.classList.remove('hidden');
            } else if (!adSdkReady) { // --- ADDED CHECK ---
                watchAdBtn.disabled = true;
                watchAdBtn.classList.add('opacity-50', 'cursor-not-allowed');
                watchAdBtn.querySelector('span').textContent = 'SDK ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                taskCompleteMsg.classList.add('hidden');
            } else {
                watchAdBtn.disabled = false;
                watchAdBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                watchAdBtn.querySelector('span').textContent = '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®';
                taskCompleteMsg.classList.add('hidden');
            }
            
            // Withdraw Page
            document.getElementById('balance-display-withdraw').textContent = data.balance.toFixed(2);
        }

        // --- Navigation Logic ---
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        const mainHeader = document.getElementById('main-header');
        const historyHeader = document.getElementById('history-header');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const pageId = item.dataset.page;
                
                // Switch active page
                pages.forEach(page => {
                    page.classList.toggle('active', page.id === `page-${pageId}`);
                });
                
                // Switch active nav item
                navItems.forEach(nav => {
                    nav.classList.toggle('active', nav.dataset.page === pageId);
                });

                // Switch header
                if (pageId === 'history') {
                    mainHeader.classList.add('hidden');
                    historyHeader.classList.remove('hidden');
                } else {
                    mainHeader.classList.remove('hidden');
                    historyHeader.classList.add('hidden');
                }
            });
        });

        // --- Modal Logic ---
        document.getElementById('close-notice-btn').addEventListener('click', () => {
            document.getElementById('notice-modal').classList.add('hidden');
        });

        // --- App Logic ---

        // Task Button (Monetag Integration)
        document.getElementById('watch-ad-btn').addEventListener('click', () => {
            if (localState.tasksCompleted >= MAX_TASKS) {
                showMessage("‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®", "‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§", "üéâ");
                return;
            }
            
            // Show loading spinner on button
            const btn = document.getElementById('watch-ad-btn');
            const btnText = btn.querySelector('span');
            btnText.textContent = '‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            btn.disabled = true;

            // --- Call Monetag Rewarded Interstitial ---
            if (typeof show_10157784 === 'function') {
                show_10157784().then(() => {
                    // Ad was watched successfully
                    console.log('User watched an ad!');
                    
                    // Update Firestore
                    const newBalance = localState.balance + TASK_REWARD;
                    const newTasks = localState.tasksCompleted + 1;
                    
                    updateDoc(userProfileRef, {
                        balance: newBalance,
                        tasksCompleted: newTasks
                    })
                    .then(() => {
                        showMessage("‡¶∞‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!", `‡¶Ü‡¶™‡¶®‡¶ø ${TASK_REWARD} TAKA ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!`, "üí∞");
                        // The UI will update automatically via the onSnapshot listener
                    })
                    .catch(e => {
                        console.error("Error updating profile after ad:", e);
                        showMessage("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "üö´");
                    });

                }).catch(e => {
                    // Ad failed to load or was skipped
                    console.error('Ad error or skip:', e);
                    showMessage("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "üòû");
                }).finally(() => {
                    // Restore button text (UI will be fully updated by listener)
                    btnText.textContent = '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®';
                    btn.disabled = false;
                });
            } else {
                console.error("Monetag SDK function 'show_10157784' not found.");
                showMessage("SDK ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "Ad SDK ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "üö´");
                btnText.textContent = '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®';
                btn.disabled = false;
            }
        });

        // Copy Referral Link
        document.getElementById('copy-link-btn').addEventListener('click', () => {
            const link = document.getElementById('referral-link').textContent;
            
            // Use fallback for clipboard API
            try {
                const textArea = document.createElement("textarea");
                textArea.value = link;
                textArea.style.position = "fixed"; //avoid scrolling to bottom
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage("‡¶ï‡¶™‡¶ø!", "‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡ßç‡¶≤‡¶ø‡¶™‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", "üìã");
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showMessage("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§", "üö´");
            }
        });
        
        // Simulate Referral Button (For Testing)
        document.getElementById('simulate-referral-btn').addEventListener('click', () => {
            const newReferrals = localState.referrals + 1;
            const newBalance = localState.balance + REFERRAL_BONUS;
            
            updateDoc(userProfileRef, {
                referrals: newReferrals,
                balance: newBalance
            })
            .then(() => {
                showMessage("‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤!", `‡¶Ü‡¶™‡¶®‡¶ø ${REFERRAL_BONUS} TAKA ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®!`, "üéâ");
            })
            .catch(e => console.error("Error simulating referral:", e));
        });

        // Withdraw Button
        document.getElementById('withdraw-btn').addEventListener('click', async () => {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            
            // Validations
            if (isNaN(amount) || amount <= 0) {
                showMessage("‡¶Ö‡¶¨‡ßà‡¶ß Amount", "‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß amount ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§", "‚ö†Ô∏è");
                return;
            }
            if (localState.balance < MIN_WITHDRAW) {
                showMessage("‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ Funds", `‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ${MIN_WITHDRAW} TAKA ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§`, "üö´");
                return;
            }
            if (localState.referrals < MIN_REFERRALS) {
                showMessage("‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤", `‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ${MIN_REFERRALS} ‡¶ü‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§`, "üö´");
                return;
            }
             if (amount < MIN_WITHDRAW) {
                showMessage("Amount ‡¶ñ‡ßÅ‡¶¨ ‡¶ï‡¶Æ", `‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ${MIN_WITHDRAW} TAKA‡•§`, "‚ö†Ô∏è");
                return;
            }
            if (amount > localState.balance) {
                showMessage("‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ Funds", "‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§", "üö´");
                return;
            }
            
            const method = document.querySelector('select').value;
            const accountNumber = document.querySelector('input[type="text"]').value;
            
            if (method === '‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®' || !accountNumber) {
                showMessage("‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®", "‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§", "‚ö†Ô∏è");
                return;
            }
            
            try {
                // 1. Add to withdrawal history
                const historyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/withdrawals`);
                await addDoc(historyCollectionRef, {
                    amount: amount,
                    method: method,
                    accountNumber: accountNumber,
                    status: "Pending", // Admin would change this
                    requestedAt: new Date()
                });
                
                // 2. Deduct from balance
                const newBalance = localState.balance - amount;
                await updateDoc(userProfileRef, {
                    balance: newBalance
                });
                
                // Success
                showMessage("‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!", `${amount} TAKA ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, "‚úÖ");
                document.getElementById('withdraw-amount').value = '';

            } catch (e) {
                console.error("Error during withdrawal:", e);
                showMessage("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø", "‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï‡¶ü‡¶æ ‡¶≠‡ßÅ‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "üö´");
            }
        });
        
        // Initial setup
        updateLoading(1, "1. Secure connection established.");

    </script>
</body>
</html>
