<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Garden</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Monetag SDK -->
    <!-- Make sure to replace 10157784 with your actual zone ID -->
    <script src='//libtl.com/sdk.js' data-zone='10157784' data-sdk='show_10157784'></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Dark background from screenshots */
            color: #e0e0e0;
        }
        /* Gradient header */
        .header-gradient {
            background: linear-gradient(90deg, #8E2DE2, #4A00E0);
        }
        /* Gradient button */
        .btn-gradient {
            background: linear-gradient(90deg, #c94dff, #ac2dff);
        }
        .btn-gradient:hover {
            background: linear-gradient(90deg, #ac2dff, #c94dff);
        }
        /* Card background */
        .card-bg {
            background-color: #2a2a4e; /* Darker card background */
        }
        .nav-bg {
            background-color: #242442;
        }
        /* Active nav item */
        .nav-item.active {
            color: #c94dff;
        }
        /* Hide all pages by default */
        .page {
            display: none;
        }
        /* Show the active page */
        .page.active {
            display: block;
        }
    </style>
</head>
<body class="h-full overflow-hidden">

    <!-- Main Application Container -->
    <div class="flex flex-col h-full max-w-md mx-auto shadow-lg">

        <!-- Header -->
        <header class="header-gradient p-4 rounded-b-2xl shadow-lg flex items-center justify-between z-10">
            <div class="flex items-center space-x-3">
                <img src="https://placehold.co/40x40/ffffff/8E2DE2?text=MD" alt="Profile" class="w-10 h-10 rounded-full border-2 border-white">
                <div>
                    <h1 class="text-lg font-bold text-white">Md.Sabbir</h1>
                    <div class="bg-white/30 backdrop-blur-sm text-white px-3 py-0.5 rounded-full text-sm inline-flex items-center">
                        Balance: <span class="font-bold ml-1" id="balance-display-header">0.00</span> TAKA
                    </div>
                </div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </header>

        <!-- Main Content Area (Scrollable) -->
        <main class="flex-1 overflow-y-auto p-4 pb-20">

            <!-- Page: Home -->
            <section id="page-home" class="page active space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="card-bg p-4 rounded-xl text-center shadow-lg">
                        <div class="text-xs text-gray-400 mb-1">Daily Ad View</div>
                        <div class="text-2xl font-bold" id="task-progress-display">0/20</div>
                    </div>
                    <div class="card-bg p-4 rounded-xl text-center shadow-lg">
                        <div class="text-xs text-gray-400 mb-1">Total Referrals</div>
                        <div class="text-2xl font-bold" id="referral-display">0</div>
                    </div>
                </div>

                <div class="card-bg p-4 rounded-xl shadow-lg space-y-3">
                    <h2 class="text-lg font-semibold text-center">üéÅ Refer friends and earn</h2>
                    <p class="text-sm text-gray-300 text-center">Share your referral link with your friends. If your friend signs up, you get a 45 TAKA bonus.</p>
                    <div class="bg-gray-800 p-3 rounded-lg text-center text-sm break-all" id="referral-link">
                        Loading link...
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="copy-link-btn" class="bg-gray-600 text-white font-semibold py-3 rounded-lg flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                                <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" />
                            </svg>
                            <span>Copy Link</span>
                        </button>
                        <button class="bg-blue-500 text-white font-semibold py-3 rounded-lg flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                            </svg>
                            <span>Share</span>
                        </button>
                    </div>
                    <!-- Button to simulate getting a referral for testing -->
                    <button id="simulate-referral-btn" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg text-sm mt-2">
                        Simulate Referral (Test)
                    </button>
                </div>
            </section>

            <!-- Page: Support -->
            <section id="page-support" class="page space-y-4">
                <div class="card-bg p-4 rounded-xl shadow-lg text-center">
                    <div class="text-6xl mb-4">‚ñ∂Ô∏è</div>
                    <h2 class="text-lg font-semibold mb-2">Tutorial Video</h2>
                    <p class="text-sm text-gray-300 mb-4">Watch the tutorial video to understand how to use the app and start earning easily.</p>
                    <button class="w-full btn-gradient text-white font-bold py-3 rounded-lg">
                        Watch Tutorial
                    </button>
                </div>
                <div class="card-bg p-4 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold mb-3">Other Help</h2>
                    <a href="#" class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                        <span class="text-blue-400">Join Telegram</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            </section>

            <!-- Page: Tasks -->
            <section id="page-tasks" class="page space-y-4">
                <div class="card-bg p-4 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold">Daily Task Progress</h2>
                        <span class="font-bold text-lg" id="task-progress-display-2">0/20</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2.5">
                        <div id="task-progress-bar" class="btn-gradient h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="text-sm text-gray-300 text-center mt-2" id="task-remaining-text">
                        20 tasks remaining today
                    </div>
                </div>

                <div class="card-bg p-4 rounded-xl shadow-lg text-center space-y-3">
                    <div class="text-5xl">üìπ</div>
                    <h2 class="text-lg font-semibold">Watch Ad</h2>
                    <p class="text-sm text-gray-300">Earn 30.00 TAKA for each ad you watch.</p>
                    <div class="text-xl font-bold text-green-400">Reward: 30.00 TAKA</div>
                    <button id="watch-ad-btn" class="w-full btn-gradient text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        <span>Watch Ad</span>
                    </button>
                    <div id="task-complete-message" class="text-green-400 font-semibold p-3 bg-green-900/50 rounded-lg hidden">
                        You have completed all tasks for today.
                    </div>
                </div>
            </section>

            <!-- Page: Withdraw -->
            <section id="page-withdraw" class="page space-y-4">
                <div class="card-bg p-4 rounded-xl shadow-lg text-center">
                    <div class="text-sm text-gray-300">Your Balance</div>
                    <div class="text-3xl font-bold my-1" id="balance-display-withdraw">0.00 <span class="text-lg">TAKA</span></div>
                </div>

                <div class="card-bg p-4 rounded-xl shadow-lg space-y-4">
                    <h2 class="text-lg font-semibold text-center mb-2">Withdraw Money</h2>
                    
                    <div class="bg-gray-800 p-3 rounded-lg">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-300">Minimum Withdrawal</span>
                            <span class="font-semibold text-green-400">800.00 TAKA</span>
                        </div>
                        <div class="flex justify-between items-center text-sm mt-1">
                            <span class="text-gray-300">Minimum Referrals</span>
                            <span class="font-semibold text-green-400">18 Users</span>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-300">Select Method</label>
                        <select class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option>Select a method</option>
                            <option>Bkash</option>
                            <option>Nagad</option>
                            <option>Rocket</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-300">Account Number</label>
                        <input type="text" placeholder="01XXXXXXXXX" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-300">Amount (TAKA)</label>
                        <input type="number" id="withdraw-amount" placeholder="Minimum 800.00 TAKA" class="w-full bg-gray-800 border border-gray-700 text-white p-3 rounded-lg mt-1 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <button id="withdraw-btn" class="w-full btn-gradient text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                        </svg>
                        <span>Submit Request</span>
                    </button>
                </div>
            </section>

            <!-- Page: History -->
            <section id="page-history" class="page space-y-4">
                <div class="card-bg p-4 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold mb-3">Your Withdrawal Record</h2>
                    <div id="history-list">
                        <!-- History items will be injected here -->
                    </div>
                    <div id="no-history-message" class="text-center py-10">
                        <div class="text-5xl mb-4">üìÑ</div>
                        <p class="font-semibold">No withdrawal history found.</p>
                        <p class="text-sm text-gray-400">You haven't made any withdrawal requests yet.</p>
                    </div>
                </div>
            </section>

        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="nav-bg fixed bottom-0 left-0 right-0 max-w-md mx-auto h-16 rounded-t-2xl flex justify-around items-center z-10 shadow-inner">
            <button class="nav-item active p-2" data-page="home">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                <span class="text-xs">Home</span>
            </button>
            <button class="nav-item p-2" data-page="support">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                <span class="text-xs">Support</span>
            </button>
            <button class="nav-item p-2" data-page="tasks">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v10a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm3 2a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                <span class="text-xs">Tasks</span>
            </button>
            <button class="nav-item p-2" data-page="withdraw">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                <span class="text-xs">Withdraw</span>
            </button>
            <button class="nav-item p-2" data-page="history">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                <span class="text-xs">History</span>
            </button>
        </nav>
    </div>

    <!-- Loading Screen Overlay -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="card-bg p-6 rounded-2xl shadow-2xl w-10/12 max-w-sm text-center">
            <div class="w-16 h-16 btn-gradient rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Loading Your Dashboard</h2>
            <p class="text-sm text-gray-300 mb-4">Securing connection & syncing data...</p>
            <div class="w-full bg-gray-800 rounded-full h-2.5">
                <div id="loading-bar" class="btn-gradient h-2.5 rounded-full" style="width: 10%"></div>
            </div>
            <ul class="text-left text-sm text-gray-400 mt-4 space-y-1" id="loading-steps">
                <li id="step-1" class="opacity-50">1. Secure connection established</li>
                <li id="step-2" class="opacity-50">2. Authenticating user...</li>
                <li id="step-3" class="opacity-50">3. Loading user profile...</li>
                <li id="step-4" class="opacity-50">4. Syncing configuration...</li>
            </ul>
        </div>
    </div>

    <!-- Notice Modal -->
    <div id="notice-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm z-40 flex items-center justify-center p-4 hidden">
        <div class="card-bg p-6 rounded-2xl shadow-2xl w-10/12 max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-4">üîî Notice</h2>
            <div class="text-left space-y-2 text-gray-200">
                <p>üî• Welcome! Work honestly and you will get 100% payment.</p>
                <p>‚ö° Join Bonus: 20 Taka</p>
                <p>üßë‚Äçü§ù‚Äçüßë Per Refer: 15 Taka</p>
                <p>üí∞ Per Ad: 30 Taka</p>
                <p>‚ù§Ô∏è Daily 20 Taka ad view opportunity.</p>
                <p>üëç No investment needed on this site.</p>
            </div>
            <button id="close-notice-btn" class="w-full btn-gradient text-white font-bold py-3 rounded-lg mt-6">
                Understood
            </button>
        </div>
    </div>
    
    <!-- Custom Message Modal (for alerts) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="card-bg p-6 rounded-2xl shadow-2xl w-10/12 max-w-sm text-center">
            <div id="message-icon" class="text-5xl mb-4"></div>
            <h2 id="message-title" class="text-xl font-bold mb-2"></h2>
            <p id="message-text" class="text-sm text-gray-300 mb-4"></p>
            <button id="close-message-btn" class="w-full bg-gray-600 text-white font-bold py-2 rounded-lg">
                Close
            </button>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            onSnapshot,
            collection,
            addDoc,
            query
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configs ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-money-garden';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const TASK_REWARD = 30;
        const REFERRAL_BONUS = 45; // From screenshot 1
        const JOIN_BONUS = 20; // From screenshot 2
        const MAX_TASKS = 20;
        const MIN_WITHDRAW = 800;
        const MIN_REFERRALS = 18;
        
        // --- Firebase Init ---
        let app, auth, db, userId, userProfileRef, userProfileUnsubscribe;
        let withdrawalHistoryUnsubscribe;
        let localState = {
            balance: 0,
            referrals: 0,
            tasksCompleted: 0
        };

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            showMessage("Error", "Could not connect to services.", "üö´");
        }

        // --- Loading Screen Logic ---
        const loadingBar = document.getElementById('loading-bar');
        const loadingSteps = {
            1: document.getElementById('step-1'),
            2: document.getElementById('step-2'),
            3: document.getElementById('step-3'),
            4: document.getElementById('step-4'),
        };
        
        function updateLoading(step, text) {
            if (loadingSteps[step]) {
                loadingSteps[step].textContent = text;
                loadingSteps[step].classList.remove('opacity-50');
                loadingSteps[step].classList.add('text-white');
            }
            loadingBar.style.width = `${step * 25}%`;
        }

        // --- Custom Message Modal ---
        const messageModal = document.getElementById('message-modal');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const messageIcon = document.getElementById('message-icon');
        const closeMessageBtn = document.getElementById('close-message-btn');

        function showMessage(title, text, icon = "‚úÖ") {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageIcon.textContent = icon;
            messageModal.classList.remove('hidden');
        }
        closeMessageBtn.onclick = () => messageModal.classList.add('hidden');


        // --- Auth State ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                updateLoading(2, "2. User authenticated.");
                userId = user.uid;
                userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profile`);
                
                // Attach real-time listener for user profile
                attachProfileListener();
                // Attach real-time listener for withdrawal history
                attachHistoryListener();

                // Update referral link
                const refLinkEl = document.getElementById('referral-link');
                const appUrl = window.location.origin + window.location.pathname;
                refLinkEl.textContent = `${appUrl}?ref=${userId}`;
                
            } else {
                // Not authenticated, try to sign in
                console.log("No user. Signing in...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Sign-in failed:", e);
                    updateLoading(2, "2. Authentication failed.");
                    showMessage("Auth Error", "Could not authenticate user.", "üö´");
                }
            }
        });

        // --- Firestore Listeners ---
        
        // Listen for profile changes (balance, tasks, etc.)
        function attachProfileListener() {
            if (userProfileUnsubscribe) userProfileUnsubscribe(); // Detach old listener
            
            userProfileUnsubscribe = onSnapshot(userProfileRef, (docSnap) => {
                updateLoading(3, "3. Loading user profile...");
                if (docSnap.exists()) {
                    // Profile exists, update local state and UI
                    const data = docSnap.data();
                    localState = {
                        balance: data.balance || 0,
                        referrals: data.referrals || 0,
                        tasksCompleted: data.tasksCompleted || 0
                    };
                    console.log("Profile data updated:", localState);
                    updateUI(localState);
                    updateLoading(4, "4. Syncing configuration...");
                    
                    // Finish loading
                    setTimeout(() => {
                        document.getElementById('loading-screen').classList.add('hidden');
                        // Show notice modal only once
                        if (!localStorage.getItem('noticeShown')) {
                            document.getElementById('notice-modal').classList.remove('hidden');
                            localStorage.setItem('noticeShown', 'true');
                        }
                    }, 500);

                } else {
                    // Profile doesn't exist, create it with join bonus
                    console.log("No profile found. Creating one...");
                    const initialProfile = {
                        balance: JOIN_BONUS,
                        referrals: 0,
                        tasksCompleted: 0,
                        joinedAt: new Date()
                    };
                    setDoc(userProfileRef, initialProfile)
                        .then(() => console.log("Profile created with join bonus."))
                        .catch(e => console.error("Error creating profile:", e));
                    // The listener will fire again with the new data
                }
            }, (error) => {
                console.error("Error listening to profile:", error);
                showMessage("Database Error", "Could not load user profile.", "üö´");
            });
        }
        
        // Listen for withdrawal history changes
        function attachHistoryListener() {
            if (withdrawalHistoryUnsubscribe) withdrawalHistoryUnsubscribe();
            
            const historyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/withdrawals`);
            const q = query(historyCollectionRef); // We can add orderBy here if we store a timestamp
            
            withdrawalHistoryUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const historyList = document.getElementById('history-list');
                const noHistoryMessage = document.getElementById('no-history-message');
                historyList.innerHTML = ''; // Clear list
                
                if (querySnapshot.empty) {
                    noHistoryMessage.style.display = 'block';
                } else {
                    noHistoryMessage.style.display = 'none';
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();
                        const date = item.requestedAt?.toDate ? item.requestedAt.toDate().toLocaleDateString() : 'N/A';
                        const itemEl = document.createElement('div');
                        itemEl.className = 'bg-gray-800 p-3 rounded-lg mb-2 flex justify-between items-center';
                        itemEl.innerHTML = `
                            <div>
                                <div class="font-semibold">${item.method} - ${item.accountNumber}</div>
                                <div class="text-sm text-gray-400">${date}</div>
                            </div>
                            <div class="text-lg font-bold text-right">
                                ${item.amount} TAKA
                                <div class="text-sm font-normal ${item.status === 'Pending' ? 'text-yellow-400' : 'text-green-400'}">${item.status}</div>
                            </div>
                        `;
                        historyList.appendChild(itemEl);
                    });
                }
            }, (error) => {
                console.error("Error listening to history:", error);
            });
        }

        // --- UI Update Function ---
        function updateUI(data) {
            // Header
            document.getElementById('balance-display-header').textContent = data.balance.toFixed(2);
            
            // Home Page
            document.getElementById('task-progress-display').textContent = `${data.tasksCompleted}/${MAX_TASKS}`;
            document.getElementById('referral-display').textContent = data.referrals;
            
            // Task Page
            const tasksDone = data.tasksCompleted;
            const progressPercent = (tasksDone / MAX_TASKS) * 100;
            document.getElementById('task-progress-display-2').textContent = `${tasksDone}/${MAX_TASKS}`;
            document.getElementById('task-progress-bar').style.width = `${progressPercent}%`;
            document.getElementById('task-remaining-text').textContent = `${MAX_TASKS - tasksDone} tasks remaining today`;
            
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const taskCompleteMsg = document.getElementById('task-complete-message');
            
            if (tasksDone >= MAX_TASKS) {
                watchAdBtn.disabled = true;
                watchAdBtn.classList.add('opacity-50', 'cursor-not-allowed');
                watchAdBtn.querySelector('span').textContent = 'Tasks Completed';
                taskCompleteMsg.classList.remove('hidden');
            } else {
                watchAdBtn.disabled = false;
                watchAdBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                watchAdBtn.querySelector('span').textContent = 'Watch Ad';
                taskCompleteMsg.classList.add('hidden');
            }
            
            // Withdraw Page
            document.getElementById('balance-display-withdraw').textContent = data.balance.toFixed(2);
        }

        // --- Navigation Logic ---
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const pageId = item.dataset.page;
                
                // Switch active page
                pages.forEach(page => {
                    page.classList.toggle('active', page.id === `page-${pageId}`);
                });
                
                // Switch active nav item
                navItems.forEach(nav => {
                    nav.classList.toggle('active', nav.dataset.page === pageId);
                });
            });
        });

        // --- Modal Logic ---
        document.getElementById('close-notice-btn').addEventListener('click', () => {
            document.getElementById('notice-modal').classList.add('hidden');
        });

        // --- App Logic ---

        // Task Button (Monetag Integration)
        document.getElementById('watch-ad-btn').addEventListener('click', () => {
            if (localState.tasksCompleted >= MAX_TASKS) {
                showMessage("Tasks Done", "You have already completed all tasks for today.", "üéâ");
                return;
            }
            
            // Show loading spinner on button
            const btn = document.getElementById('watch-ad-btn');
            const btnText = btn.querySelector('span');
            btnText.textContent = 'Loading Ad...';
            btn.disabled = true;

            // --- Call Monetag Rewarded Interstitial ---
            // This 'show_10157784' function is from the Monetag SDK
            if (typeof show_10157784 === 'function') {
                show_10157784().then(() => {
                    // Ad was watched successfully
                    console.log('User watched an ad!');
                    
                    // Update Firestore
                    const newBalance = localState.balance + TASK_REWARD;
                    const newTasks = localState.tasksCompleted + 1;
                    
                    updateDoc(userProfileRef, {
                        balance: newBalance,
                        tasksCompleted: newTasks
                    })
                    .then(() => {
                        showMessage("Reward!", `You have earned ${TASK_REWARD} TAKA!`, "üí∞");
                        // The UI will update automatically via the onSnapshot listener
                    })
                    .catch(e => {
                        console.error("Error updating profile after ad:", e);
                        showMessage("Error", "Could not save your reward. Please try again.", "üö´");
                    });

                }).catch(e => {
                    // Ad failed to load or was skipped
                    console.error('Ad error or skip:', e);
                    showMessage("Ad Error", "The ad could not be shown. Please try again later.", "üòû");
                }).finally(() => {
                    // Restore button text (UI will be fully updated by listener)
                    btnText.textContent = 'Watch Ad';
                    btn.disabled = false;
                });
            } else {
                console.error("Monetag SDK function 'show_10157784' not found.");
                showMessage("SDK Error", "Ad SDK is not loaded. Please refresh.", "üö´");
                btnText.textContent = 'Watch Ad';
                btn.disabled = false;
            }
        });

        // Copy Referral Link
        document.getElementById('copy-link-btn').addEventListener('click', () => {
            const link = document.getElementById('referral-link').textContent;
            
            // Use fallback for clipboard API
            try {
                const textArea = document.createElement("textarea");
                textArea.value = link;
                textArea.style.position = "fixed"; //avoid scrolling to bottom
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage("Copied!", "Referral link copied to clipboard.", "üìã");
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showMessage("Error", "Could not copy link.", "üö´");
            }
        });
        
        // Simulate Referral Button (For Testing)
        document.getElementById('simulate-referral-btn').addEventListener('click', () => {
            const newReferrals = localState.referrals + 1;
            const newBalance = localState.balance + REFERRAL_BONUS;
            
            updateDoc(userProfileRef, {
                referrals: newReferrals,
                balance: newBalance
            })
            .then(() => {
                showMessage("Referral!", `You got a referral bonus of ${REFERRAL_BONUS} TAKA!`, "üéâ");
            })
            .catch(e => console.error("Error simulating referral:", e));
        });

        // Withdraw Button
        document.getElementById('withdraw-btn').addEventListener('click', async () => {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            
            // Validations
            if (isNaN(amount) || amount <= 0) {
                showMessage("Invalid Amount", "Please enter a valid amount.", "‚ö†Ô∏è");
                return;
            }
            if (localState.balance < MIN_WITHDRAW) {
                showMessage("Insufficient Funds", `You need at least ${MIN_WITHDRAW} TAKA to withdraw.`, "üö´");
                return;
            }
            if (localState.referrals < MIN_REFERRALS) {
                showMessage("Not Enough Referrals", `You need at least ${MIN_REFERRALS} referrals to withdraw.`, "üö´");
                return;
            }
             if (amount < MIN_WITHDRAW) {
                showMessage("Amount Too Low", `Minimum withdrawal amount is ${MIN_WITHDRAW} TAKA.`, "‚ö†Ô∏è");
                return;
            }
            if (amount > localState.balance) {
                showMessage("Insufficient Funds", "You cannot withdraw more than your balance.", "üö´");
                return;
            }
            
            const method = document.querySelector('select').value;
            const accountNumber = document.querySelector('input[type="text"]').value;
            
            if (method === 'Select a method' || !accountNumber) {
                showMessage("Missing Info", "Please select a method and enter your account number.", "‚ö†Ô∏è");
                return;
            }
            
            try {
                // 1. Add to withdrawal history
                const historyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/withdrawals`);
                await addDoc(historyCollectionRef, {
                    amount: amount,
                    method: method,
                    accountNumber: accountNumber,
                    status: "Pending", // Admin would change this
                    requestedAt: new Date()
                });
                
                // 2. Deduct from balance
                const newBalance = localState.balance - amount;
                await updateDoc(userProfileRef, {
                    balance: newBalance
                });
                
                // Success
                showMessage("Request Sent!", `Your request to withdraw ${amount} TAKA has been submitted.`, "‚úÖ");
                document.getElementById('withdraw-amount').value = '';

            } catch (e) {
                console.error("Error during withdrawal:", e);
                showMessage("Error", "Something went wrong. Please try again.", "üö´");
            }
        });
        
        // Initial setup
        updateLoading(1, "1. Secure connection established.");

    </script>
</body>
</html>
